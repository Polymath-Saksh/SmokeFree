{% extends "base.html" %}
{% block content %}
<h2>Log a Craving</h2>
<form method="post" id="craving-form">
	{% csrf_token %}
	{{ form.as_p }}
	<div id="map" style="width:100%;height:400px;margin-bottom:1em;"></div>
	<button type="submit" class="btn btn-primary">Log Craving</button>
</form>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}"></script>

<script>
	let map, marker;

	function initMap() {
		// Default location (e.g., Delhi)
		let lat = 0, lng = 0;
		// Try to use user's current location
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function (position) {
				lat = position.coords.latitude;
				lng = position.coords.longitude;
				setMap(lat, lng);
			}, function () {
				setMap(lat, lng);
			});
		} else {
			setMap(lat, lng);
		}
	}

	function setMap(lat, lng) {
		map = new google.maps.Map(document.getElementById('map'), {
			center: { lat: lat, lng: lng },
			zoom: 14
		});

		marker = new google.maps.Marker({
			position: { lat: lat, lng: lng },
			map: map,
			draggable: true,
			title: "Drag me or click to set location"
		});

		// Set initial values
		document.getElementById('id_latitude').value = lat;
		document.getElementById('id_longitude').value = lng;

		// Update lat/lng on marker drag
		marker.addListener('dragend', function (event) {
			document.getElementById('id_latitude').value = event.latLng.lat();
			document.getElementById('id_longitude').value = event.latLng.lng();
		});

		// Allow user to click on map to move marker
		map.addListener('click', function (event) {
			marker.setPosition(event.latLng);
			document.getElementById('id_latitude').value = event.latLng.lat();
			document.getElementById('id_longitude').value = event.latLng.lng();
		});
	}

	window.onload = initMap;
</script>
{% endblock %}